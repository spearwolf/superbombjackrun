!function(a){if("function"==typeof bootstrap)bootstrap("promise",a);else if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=a}else Q=a()}(function(){"use strict";function a(a){return function(){return X.apply(a,arguments)}}function b(a){return a===Object(a)}function c(a){return"[object StopIteration]"===db(a)||a instanceof T}function d(a,b){if(Q&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(fb)){for(var c=[],d=b;d;d=d.source)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var f=c.join("\n"+fb+"\n");a.stack=e(f)}}function e(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];h(e)||f(e)||!e||c.push(e)}return c.join("\n")}function f(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function g(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function h(a){var b=g(a);if(!b)return!1;var c=b[0],d=b[1];return c===S&&d>=U&&kb>=d}function i(){if(Q)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=g(c);if(!d)return;return S=d[0],d[1]}}function j(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack),a.apply(a,arguments)}}function k(a){return r(a)?a:s(a)?D(a):C(a)}function l(){function a(a){b=a,f.source=a,Z(c,function(b,c){W(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=ab(l.prototype),f=ab(o.prototype);if(f.promiseDispatch=function(a,e,f){var g=Y(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):W(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=q(b);return r(a)&&(b=a),a},f.inspect=function(){return b?b.inspect():{state:"pending"}},k.longStackSupport&&Q)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(k(c))},e.fulfill=function(c){b||a(C(c))},e.reject=function(c){b||a(B(c))},e.notify=function(a){b||Z(d,function(b,c){W(function(){c(a)})},void 0)},e}function m(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=l();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function n(a){return m(function(b,c){for(var d=0,e=a.length;e>d;d++)k(a[d]).then(b,c)})}function o(a,b,c){void 0===b&&(b=function(a){return B(new Error("Promise does not support operation: "+a))}),void 0===c&&(c=function(){return{state:"unknown"}});var d=ab(o.prototype);if(d.promiseDispatch=function(c,e,f){var g;try{g=a[e]?a[e].apply(d,f):b.call(d,e,f)}catch(h){g=B(h)}c&&c(g)},d.inspect=c,c){var e=c();"rejected"===e.state&&(d.exception=e.reason),d.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value}}return d}function p(a,b,c,d){return k(a).then(b,c,d)}function q(a){if(r(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function r(a){return b(a)&&"function"==typeof a.promiseDispatch&&"function"==typeof a.inspect}function s(a){return b(a)&&"function"==typeof a.then}function t(a){return r(a)&&"pending"===a.inspect().state}function u(a){return!r(a)||"fulfilled"===a.inspect().state}function v(a){return r(a)&&"rejected"===a.inspect().state}function w(){!ib&&"undefined"!=typeof window&&window.console&&console.warn("[Q] Unhandled rejection reasons (should be empty):",gb),ib=!0}function x(){for(var a=0;a<gb.length;a++){var b=gb[a];console.warn("Unhandled rejection reason:",b)}}function y(){gb.length=0,hb.length=0,ib=!1,jb||(jb=!0,"undefined"!=typeof process&&process.on&&process.on("exit",x))}function z(a,b){jb&&(hb.push(a),gb.push(b&&"undefined"!=typeof b.stack?b.stack:"(no stack) "+b),w())}function A(a){if(jb){var b=$(hb,a);-1!==b&&(hb.splice(b,1),gb.splice(b,1))}}function B(a){var b=o({when:function(b){return b&&A(this),b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});return z(b,a),b}function C(a){return o({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return cb(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function D(a){var b=l();return W(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function E(a){return o({isDef:function(){}},function(b,c){return K(a,b,c)},function(){return k(a).inspect()})}function F(a,b,c){return k(a).spread(b,c)}function G(a){return function(){function b(a,b){var g;if(eb){try{g=d[a](b)}catch(h){return B(h)}return g.done?g.value:p(g.value,e,f)}try{g=d[a](b)}catch(h){return c(h)?h.value:B(h)}return p(g,e,f)}var d=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}}function H(a){k.done(k.async(a)())}function I(a){throw new T(a)}function J(a){return function(){return F([this,L(arguments)],function(b,c){return a.apply(b,c)})}}function K(a,b,c){return k(a).dispatch(b,c)}function L(a){return p(a,function(a){var b=0,c=l();return Z(a,function(d,e,f){var g;r(e)&&"fulfilled"===(g=e.inspect()).state?a[f]=g.value:(++b,p(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0),0===b&&c.resolve(a),c.promise})}function M(a){return p(a,function(a){return a=_(a,k),p(L(_(a,function(a){return p(a,V,V)})),function(){return a})})}function N(a){return k(a).allSettled()}function O(a,b){return k(a).then(void 0,void 0,b)}function P(a,b){return k(a).nodeify(b)}var Q=!1;try{throw new Error}catch(R){Q=!!R.stack}var S,T,U=i(),V=function(){},W=function(){function a(){for(;b.next;){b=b.next;var c=b.task;b.task=void 0;var e=b.domain;e&&(b.domain=void 0,e.enter());try{c()}catch(g){if(f)throw e&&e.exit(),setTimeout(a,0),e&&e.enter(),g;setTimeout(function(){throw g},0)}e&&e.exit()}d=!1}var b={task:void 0,next:null},c=b,d=!1,e=void 0,f=!1;if(W=function(a){c=c.next={task:a,domain:f&&process.domain,next:null},d||(d=!0,e())},"undefined"!=typeof process&&process.nextTick)f=!0,e=function(){process.nextTick(a)};else if("function"==typeof setImmediate)e="undefined"!=typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!=typeof MessageChannel){var g=new MessageChannel;g.port1.onmessage=function(){e=h,g.port1.onmessage=a,a()};var h=function(){g.port2.postMessage(0)};e=function(){setTimeout(a,0),h()}}else e=function(){setTimeout(a,0)};return W}(),X=Function.call,Y=a(Array.prototype.slice),Z=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),$=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),_=a(Array.prototype.map||function(a,b){var c=this,d=[];return Z(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),ab=Object.create||function(a){function b(){}return b.prototype=a,new b},bb=a(Object.prototype.hasOwnProperty),cb=Object.keys||function(a){var b=[];for(var c in a)bb(a,c)&&b.push(c);return b},db=a(Object.prototype.toString);T="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var eb;try{new Function("(function* (){ yield 1; })"),eb=!0}catch(R){eb=!1}var fb="From previous event:";k.resolve=k,k.nextTick=W,k.longStackSupport=!1,k.defer=l,l.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):a.resolve(arguments.length>2?Y(arguments,1):c)}},k.promise=m,k.passByCopy=function(a){return a},o.prototype.passByCopy=function(){return this},k.join=function(a,b){return k(a).join(b)},o.prototype.join=function(a){return k([this,a]).spread(function(a,b){if(a===b)return a;throw new Error("Can't join: not the same: "+a+" "+b)})},k.race=n,o.prototype.race=function(){return this.then(k.race)},k.makePromise=o,o.prototype.toString=function(){return"[object Promise]"},o.prototype.then=function(a,b,c){function e(b){try{return"function"==typeof a?a(b):b}catch(c){return B(c)}}function f(a){if("function"==typeof b){d(a,h);try{return b(a)}catch(c){return B(c)}}return B(a)}function g(a){return"function"==typeof c?c(a):a}var h=this,i=l(),j=!1;return W(function(){h.promiseDispatch(function(a){j||(j=!0,i.resolve(e(a)))},"when",[function(a){j||(j=!0,i.resolve(f(a)))}])}),h.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=g(a)}catch(d){if(c=!0,!k.onerror)throw d;k.onerror(d)}c||i.notify(b)}]),i.promise},k.when=p,o.prototype.thenResolve=function(a){return this.then(function(){return a})},k.thenResolve=function(a,b){return k(a).thenResolve(b)},o.prototype.thenReject=function(a){return this.then(function(){throw a})},k.thenReject=function(a,b){return k(a).thenReject(b)},k.nearer=q,k.isPromise=r,k.isPromiseAlike=s,k.isPending=t,o.prototype.isPending=function(){return"pending"===this.inspect().state},k.isFulfilled=u,o.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},k.isRejected=v,o.prototype.isRejected=function(){return"rejected"===this.inspect().state};var gb=[],hb=[],ib=!1,jb=!0;k.resetUnhandledRejections=y,k.getUnhandledReasons=function(){return gb.slice()},k.stopUnhandledRejectionTracking=function(){y(),"undefined"!=typeof process&&process.on&&process.removeListener("exit",x),jb=!1},y(),k.reject=B,k.fulfill=C,k.master=E,k.spread=F,o.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)},k.async=G,k.spawn=H,k["return"]=I,k.promised=J,k.dispatch=K,o.prototype.dispatch=function(a,b){var c=this,d=l();return W(function(){c.promiseDispatch(d.resolve,a,b)}),d.promise},k.get=function(a,b){return k(a).dispatch("get",[b])},o.prototype.get=function(a){return this.dispatch("get",[a])},k.set=function(a,b,c){return k(a).dispatch("set",[b,c])},o.prototype.set=function(a,b){return this.dispatch("set",[a,b])},k.del=k["delete"]=function(a,b){return k(a).dispatch("delete",[b])},o.prototype.del=o.prototype["delete"]=function(a){return this.dispatch("delete",[a])},k.mapply=k.post=function(a,b,c){return k(a).dispatch("post",[b,c])},o.prototype.mapply=o.prototype.post=function(a,b){return this.dispatch("post",[a,b])},k.send=k.mcall=k.invoke=function(a,b){return k(a).dispatch("post",[b,Y(arguments,2)])},o.prototype.send=o.prototype.mcall=o.prototype.invoke=function(a){return this.dispatch("post",[a,Y(arguments,1)])},k.fapply=function(a,b){return k(a).dispatch("apply",[void 0,b])},o.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])},k["try"]=k.fcall=function(a){return k(a).dispatch("apply",[void 0,Y(arguments,1)])},o.prototype.fcall=function(){return this.dispatch("apply",[void 0,Y(arguments)])},k.fbind=function(a){var b=k(a),c=Y(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(Y(arguments))])}},o.prototype.fbind=function(){var a=this,b=Y(arguments);return function(){return a.dispatch("apply",[this,b.concat(Y(arguments))])}},k.keys=function(a){return k(a).dispatch("keys",[])},o.prototype.keys=function(){return this.dispatch("keys",[])},k.all=L,o.prototype.all=function(){return L(this)},k.allResolved=j(M,"allResolved","allSettled"),o.prototype.allResolved=function(){return M(this)},k.allSettled=N,o.prototype.allSettled=function(){return this.then(function(a){return L(_(a,function(a){function b(){return a.inspect()}return a=k(a),a.then(b,b)}))})},k.fail=k["catch"]=function(a,b){return k(a).then(void 0,b)},o.prototype.fail=o.prototype["catch"]=function(a){return this.then(void 0,a)},k.progress=O,o.prototype.progress=function(a){return this.then(void 0,void 0,a)},k.fin=k["finally"]=function(a,b){return k(a)["finally"](b)},o.prototype.fin=o.prototype["finally"]=function(a){return a=k(a),this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b})})},k.done=function(a,b,c,d){return k(a).done(b,c,d)},o.prototype.done=function(a,b,c){var e=function(a){W(function(){if(d(a,f),!k.onerror)throw a;k.onerror(a)})},f=a||b||c?this.then(a,b,c):this;"object"==typeof process&&process&&process.domain&&(e=process.domain.bind(e)),f.then(void 0,e)},k.timeout=function(a,b,c){return k(a).timeout(b,c)},o.prototype.timeout=function(a,b){var c=l(),d=setTimeout(function(){c.reject(new Error(b||"Timed out after "+a+" ms"))},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)},c.notify),c.promise},k.delay=function(a,b){return void 0===b&&(b=a,a=void 0),k(a).delay(b)},o.prototype.delay=function(a){return this.then(function(b){var c=l();return setTimeout(function(){c.resolve(b)},a),c.promise})},k.nfapply=function(a,b){return k(a).nfapply(b)},o.prototype.nfapply=function(a){var b=l(),c=Y(a);return c.push(b.makeNodeResolver()),this.fapply(c).fail(b.reject),b.promise},k.nfcall=function(a){var b=Y(arguments,1);return k(a).nfapply(b)},o.prototype.nfcall=function(){var a=Y(arguments),b=l();return a.push(b.makeNodeResolver()),this.fapply(a).fail(b.reject),b.promise},k.nfbind=k.denodeify=function(a){var b=Y(arguments,1);return function(){var c=b.concat(Y(arguments)),d=l();return c.push(d.makeNodeResolver()),k(a).fapply(c).fail(d.reject),d.promise}},o.prototype.nfbind=o.prototype.denodeify=function(){var a=Y(arguments);return a.unshift(this),k.denodeify.apply(void 0,a)},k.nbind=function(a,b){var c=Y(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(Y(arguments)),f=l();return e.push(f.makeNodeResolver()),k(d).fapply(e).fail(f.reject),f.promise}},o.prototype.nbind=function(){var a=Y(arguments,0);return a.unshift(this),k.nbind.apply(void 0,a)},k.nmapply=k.npost=function(a,b,c){return k(a).npost(b,c)},o.prototype.nmapply=o.prototype.npost=function(a,b){var c=Y(b||[]),d=l();return c.push(d.makeNodeResolver()),this.dispatch("post",[a,c]).fail(d.reject),d.promise},k.nsend=k.nmcall=k.ninvoke=function(a,b){var c=Y(arguments,2),d=l();return c.push(d.makeNodeResolver()),k(a).dispatch("post",[b,c]).fail(d.reject),d.promise},o.prototype.nsend=o.prototype.nmcall=o.prototype.ninvoke=function(a){var b=Y(arguments,1),c=l();return b.push(c.makeNodeResolver()),this.dispatch("post",[a,b]).fail(c.reject),c.promise},k.nodeify=P,o.prototype.nodeify=function(a){return a?void this.then(function(b){W(function(){a(null,b)})},function(b){W(function(){a(b)})}):this};var kb=i();return k}),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var Stats=function(){var a=Date.now(),b=a,c=0,d=1/0,e=0,f=0,g=1/0,h=0,i=0,j=0,k=document.createElement("div");k.id="stats",k.addEventListener("mousedown",function(a){a.preventDefault(),s(++j%2)},!1),k.style.cssText="width:80px;opacity:0.9;cursor:pointer";var l=document.createElement("div");l.id="fps",l.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",k.appendChild(l);var m=document.createElement("div");m.id="fpsText",m.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",m.innerHTML="FPS",l.appendChild(m);var n=document.createElement("div");for(n.id="fpsGraph",n.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",l.appendChild(n);74>n.children.length;){var o=document.createElement("span");o.style.cssText="width:1px;height:30px;float:left;background-color:#113",n.appendChild(o)}var p=document.createElement("div");p.id="ms",p.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",k.appendChild(p);var q=document.createElement("div");q.id="msText",q.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",q.innerHTML="MS",p.appendChild(q);var r=document.createElement("div");for(r.id="msGraph",r.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",p.appendChild(r);74>r.children.length;)o=document.createElement("span"),o.style.cssText="width:1px;height:30px;float:left;background-color:#131",r.appendChild(o);var s=function(a){switch(j=a){case 0:l.style.display="block",p.style.display="none";break;case 1:l.style.display="none",p.style.display="block"}};return{REVISION:11,domElement:k,setMode:s,begin:function(){a=Date.now()},end:function(){var j=Date.now();c=j-a,d=Math.min(d,c),e=Math.max(e,c),q.textContent=c+" MS ("+d+"-"+e+")";var k=Math.min(30,30-30*(c/200));return r.appendChild(r.firstChild).style.height=k+"px",i++,j>b+1e3&&(f=Math.round(1e3*i/(j-b)),g=Math.min(g,f),h=Math.max(h,f),m.textContent=f+" FPS ("+g+"-"+h+")",k=Math.min(30,30-30*(f/100)),n.appendChild(n.firstChild).style.height=k+"px",b=j,i=0),j},update:function(){a=this.end()}}};!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){!function(){"use strict";var c=b.exports=a("./held/core");a("./held/canvas"),a("./held/loop"),a("./held/assets_manager"),c.AsciiTilemap=a("./held/ascii_tilemap");var d=a("./held/canvas_grid_viewport").createViewport;c.AsciiTilemap.createViewport=function(a){return d(a.canvasGrid)},c.init=function(){return c.on("init",arguments[0])},c.resize=function(){return c.on("resize",arguments[0])},c.idle=function(){return c.on("idle",arguments[0])}}()},{"./held/ascii_tilemap":2,"./held/assets_manager":3,"./held/canvas":6,"./held/canvas_grid_viewport":8,"./held/core":10,"./held/loop":12}],2:[function(a,b){!function(b){"use strict";var c=a("./canvas_grid.coffee").CanvasGrid;b.create=function(){var a={tileWidth:0,tileHeight:0,pixelWidth:0,pixelHeight:0,tileSize:0,tileset:null,tilemap:[],canvasGrid:null,charTileMap:{" ":"ground",".":"nowhere",",":"marble",_:"stone","#":"stonewall",A:"stonewall-door"}};return a.setMapData=function(b){return a.tilemap=b,a.tileWidth=b[0].length,a.tileHeight=b.length,a},a.setTileset=function(b){return a.tileset=b,a.tileSize=b.getFirstFrame().w,a},a.createCanvasGrid=function(){return a.canvasGrid?a:(a.pixelWidth=a.tileWidth*a.tileSize,a.pixelHeight=a.tileHeight*a.tileSize,a.canvasGrid=new c(a.tileWidth,a.tileHeight,a.tileSize),a.drawAll(),a)},a.drawAll=function(){var b,c,d,e;for(c=0;c<a.tilemap.length;c++)for(b=0;b<a.tilemap[c].length;b++)d=a.tilemap[c][b],e=a.tileset.frame(a.charTileMap[d]),a.canvasGrid.renderTile(b,c,a.tileset.image.canvas,e.x,e.y)},a}}(b.exports)},{"./canvas_grid.coffee":7}],3:[function(a,b){!function(){"use strict";function b(a){this.message=a,this.name="AssetManagerException"}var c=a("./core"),d=a("./basic_canvas.coffee"),e=a("./canvas_utils.js"),f=a("./tileset_utils.js");c.factory("assetsManager",function(){function a(a,b,c){var d={path:a};return"number"==typeof arguments[1]?(d.name=a,d.pixelZoom=b):"string"==typeof arguments[1]&&(d.name=b,d.pixelZoom=c||1),d}function g(a){var b=a.match(/(.*\/)[^\/]*$/);return b?b[1]:""}var h={promise:{},image:{},tileset:{}};return h.addImage=function(c,f,g){var i=a(c,f,g);if(h.image[i.name])throw new b("image already exists! name="+i.name);var j=d.fromImage(i.path,i.pixelZoom),k="image:"+i.name;h.promise[k]=j,j.then(function(a){h.image[i.name]=e.extend(a),console.log("AssetManager","image loaded, name=",i.name,"path=",i.path,"data=",a),delete h.promise[k]})},h.addTileset=function(i,j,k){var l=a(i,j,k);if(h.tileset[l.name])throw new b("tileset already exists! name="+l.name);var m=c.get("http").getJson(l.path),n="tileset:"+l.name,o="image:"+l.name,p=Q.defer();h.promise[n]=m,h.promise[o]=p.promise,m.then(function(a){console.log("AssetManager","tileset json",a);var b=g(l.path)+a.meta.image;console.log("AssetManager","tileset image",b),d.fromImage(b,l.pixelZoom).then(function(b){h.image[a.meta.image]=e.extend(b),h.tileset[l.name]=f.extend({config:a,image:b}),f.setPixelZoom(a,l.pixelZoom),console.log("AssetManager","tileset loaded",h.tileset[l.name]),p.resolve(),delete h.promise[o]}),delete h.promise[n]})},h.waitForAll=function(){var a=Object.keys(h.image).map(function(a){return h.image[a].promise}).concat(Object.keys(h.promise).map(function(a){return h.promise[a]})).filter(function(a){return!!a});return Q.all(a)},h.getImage=function(a){return h.image[a]},h.getTileset=function(a){return h.tileset[a]},h})}(b.exports)},{"./basic_canvas.coffee":4,"./canvas_utils.js":9,"./core":10,"./tileset_utils.js":13}],4:[function(a,b){var c;b.exports=c=function(){function a(a){this.options=null!=a?a:{},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),null!=this.options.width&&null!=this.options.height&&this.setSize(this.options.width,this.options.height),null!=this.options.appendTo&&this.appendTo(this.options.appendTo)}return a.prototype.setSize=function(a,b){var c;return this.width=a,this.height=b,this.canvas.width=this.width,this.canvas.height=this.height,c=this.width*this.height,c>5e6?(c=Math.round(10*c)/10,console.log("WARN canvas size of "+this.width+"x"+this.height+" ~"+c+"MP might be too big for mobile devices!")):void 0},a.prototype.appendTo=function(a){var b;return this.parent=a,"string"==typeof this.parent&&(this.parent=document.getElementById(this.parent)),this.parent.appendChild(this.canvas),null==this.width||null==this.height?(b=[this.canvas.width,this.canvas.height],this.width=b[0],this.height=b[1],b):void 0},a.prototype.fillRect=function(){return this.ctx.fillRect(0,0,this.width,this.height)},a.prototype.imageData=function(a){return a?this.ctx.putImageData(a,0,0):this.ctx.getImageData(0,0,this.width,this.height)},a}()},{}],5:[function(a,b){function c(a,b){var c,d,e,f,g,h,i=a.imageData(),j=b.imageData(),k=b.width,l=b.height,m=a.width,n=m/k,o=a.height/l;for(d=0;l>d;d++)for(c=0;k>c;c++)e=n*c|0,f=o*d|0,g=f*m+e<<2,h=d*k+c<<2,j.data[h]=i.data[g],j.data[h+1]=i.data[g+1],j.data[h+2]=i.data[g+2],j.data[h+3]=i.data[g+3];b.imageData(j)}var d=a("./basic_canvas.coffee");b.exports=function(a,b){var e=Q.defer(),f=new Image;return f.onload=function(){var a=new d;if(a.setSize(f.width,f.height),a.ctx.drawImage(f,0,0,f.width,f.height),"number"==typeof b&&1!==b){var g=new d;g.setSize(f.width*b|0,f.height*b|0),c(a,g),a=g}e.resolve(a)},f.src=a,e.promise}},{"./basic_canvas.coffee":4}],6:[function(a,b){!function(){"use strict";var b=a("./core"),c=b.context();b.BasicCanvas=a("./basic_canvas.coffee"),b.BasicCanvas.fromImage=a("./basic_canvas_from_image"),b.CanvasGrid=a("./canvas_grid.coffee"),b.factory("clearBg",function(){return function(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.restore()}}),b.resizeCanvas=function(){var a=window.innerWidth,d=window.innerHeight,e=window.devicePixelRatio||1,f=a*e,g=d*e;c.devicePixelRatio=e,(c.canvas.width!==f||c.canvas.height!==g)&&(c.width=c.canvas.width=f,c.height=c.canvas.height=g,c.canvas.style.width=a+"px",c.canvas.style.height=d+"px",b.emit("resize",f,g))},b.createMainCanvas=function(a){var d=c.canvas=document.createElement("canvas");navigator.isCocoonJS&&"2d"===a&&(d.screencanvas=!0);c.ctx=d.getContext(a);b.resizeCanvas(),document.body.appendChild(d),window.addEventListener("resize",function(){c.shouldResize=!0})},b.createStatsWidget=function(){if(!navigator.isCocoonJS){var a=c.stats=new Stats;a.setMode(0),a.domElement.style.position="absolute",a.domElement.style.top="0",a.domElement.style.left="0",document.body.appendChild(a.domElement)}}}(b.exports)},{"./basic_canvas.coffee":4,"./basic_canvas_from_image":5,"./canvas_grid.coffee":7,"./core":10}],7:[function(a,b){var c,d,e;c=a("./basic_canvas.coffee"),e=1024,b.exports.CanvasGrid=d=function(){function a(a,b,d,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;for(this.width=a,this.height=b,this.tileSize=d,this.maxGridCanvasSize=null!=f?f:e,m=this.maxGridCanvasSize/this.tileSize|0,this.gridWidth=0|Math.ceil(this.width/m),this.gridHeight=0|Math.ceil(this.height/m),this.gridPixelSize=m*this.tileSize,g=this.width-(this.gridWidth-1)*m,h=this.height-(this.gridHeight-1)*m,this.pixelWidth=this.width*this.tileSize,this.pixelHeight=this.height*this.tileSize,this.grid=[],r=0,q=s=0,w=this.gridHeight-1;w>=0?w>=s:s>=w;q=w>=0?++s:--s){for(p=0,o=t=0,x=this.gridWidth-1;x>=0?x>=t:t>=x;o=x>=0?++t:--t)n=o===this.gridWidth-1?g*this.tileSize:this.gridPixelSize,k=q===this.gridHeight-1?h*this.tileSize:this.gridPixelSize,l=o+q*this.gridWidth,this.grid[l]={canvas:new c({width:n,height:k}),x0:p,y0:r,x1:p+n-1,y1:r+k-1,gx:o,gy:q},p+=n;r+=k}for(this.tileProps=[],j=0,q=u=0,y=this.height-1;y>=0?y>=u:u>=y;q=y>=0?++u:--u)for(this.tileProps[q]=[],i=0,q*this.tileSize>this._grid(i,j).y1&&(j+=1),o=v=0,z=this.width-1;z>=0?z>=v:v>=z;o=z>=0?++v:--v)o*this.tileSize>this._grid(i,j).x1&&(i+=1),this.tileProps[q][o]={grid:this._grid(i,j),x:o*this.tileSize,y:q*this.tileSize}}return a.prototype._grid=function(a,b){return this.grid[b*this.gridWidth+a]},a.prototype.getCanvas=function(a,b){return this.tileProps[b][a].grid.canvas},a.prototype.getGrid=function(a,b){return this._grid(a/this.gridPixelSize|0,b/this.gridPixelSize|0)},a.prototype.renderTile=function(a,b,c,d,e){var f;return f=this.tileProps[b][a].grid,f.canvas.ctx.drawImage(c,d,e,this.tileSize,this.tileSize,a*this.tileSize-f.x0,b*this.tileSize-f.y0,this.tileSize,this.tileSize)},a.prototype.renderTo=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(k=this.getGrid(b,c),f=this.getGrid(b+d-1,c+e-1),k.gx===f.gx&&k.gy===f.gy)return o=b-k.x0,p=c-k.y0,a.ctx.drawImage(k.canvas.canvas,o,p,d,e,0,0,d,e);for(g=null,t=[],i=q=r=k.gy,s=f.gy;s>=r?s>=q:q>=s;i=s>=r?++q:--q)t.push(function(){var q,r,s,t;for(t=[],h=q=r=k.gx,s=f.gx;s>=r?s>=q:q>=s;h=s>=r?++q:--q)g=this._grid(h,i),h===k.gx?(o=b-k.x0,l=0):(o=0,l=g.x0-b),i===k.gy?(p=c-k.y0,m=0):(p=0,m=g.y0-c),n=h===f.gx?b+d-f.x0-o:g.canvas.width-o,j=i===f.gy?c+e-f.y0-p:g.canvas.height-p,t.push(a.ctx.drawImage(g.canvas.canvas,o,p,n,j,l,m,n,j));return t}.call(this));return t},a}()},{"./basic_canvas.coffee":4}],8:[function(a,b){!function(a){"use strict";a.createViewport=function(a){var b={canvasGrid:a,x:0,y:0,target:{}};return b.setTarget=function(a){return b.target.canvas=a,b},b.setViewportSize=function(a,c){return b.w=a,b.h=c,b.target.w=b.x+a<b.canvasGrid.pixelWidth?a:b.canvasGrid.pixelWidth-b.x,b.target.h=b.y+c<b.canvasGrid.pixelHeight?c:b.canvasGrid.pixelHeight-b.y,b},b.draw=function(){b.canvasGrid.renderTo(b.target.canvas,b.x,b.y,b.target.w,b.target.h)},b}}(b.exports)},{}],9:[function(a,b){!function(){"use strict";b.exports={extend:function(a){var b=Object.create(a);return b.draw=function(a,b,c){a.drawImage(this.canvas,b,c,this.width,this.height)},b}}}()},{}],10:[function(a,b){!function(a){"use strict";var b={_id:0},c={},d={};c.try=function(a,b){return c[a]?"function"==typeof c[a][b]?c[a][b]():c[a][b]:void 0},a.on=function(a,c,d){2===arguments.length&&(d=c,c=0);var e=b[a]||(b[a]=[]),f=++b._id;return e.push({id:f,fn:d,prio:c||0}),e.sort(function(a,b){return b.prio-a.prio}),f},a.off=function(a){var c,d,e;for(c in b)if(b.hasOwnProperty(c))for(d=0;d<b[c].length;d++)if(e=b[c][d],e.id===a)return void b[c].splice(d,1)},a.emit=function(c){var d=Array.prototype.slice.call(arguments,1);c in b&&b[c].forEach(function(b){a.apply(b.fn,d)})},a.context=function(b,d){return 2!==arguments.length?1===arguments.length?c[b]:c:void(c[b]=d instanceof Array&&"function"==typeof d[d.length-1]?function(){return a.apply(d,arguments)}:d)},a.get=function(a,b){var e;return"$h"===a?c:(e=d[a])?e.api:(b||c)[a]},a.apply=function(b,d){var e=b.$h||c;if(d&&0===d.length&&(d=void 0),"function"==typeof b)return b.apply(e,d);if(b.length)for(var f=[],g=0;g<b.length;g++){if(!(g<b.length-1))return b[g].apply(e,d?f.concat(d):f);f.push(a.get(b[g],e))}},a.run=function(b){return a.apply(b,Array.prototype.slice.call(arguments,1))},a.factory=function(b,e){var f=Object.create(c);e.$h=f;var g={name:b,context:f,api:a.run(e)};return g.isFunction="function"==typeof g.api,g.isFunction&&(g.api=g.api.bind(g.context)),d[b]=g}}(b.exports)},{}],11:[function(a,b){!function(){"use strict";var b=a("./core");b.factory("http",function(){var a={};return a.getJson=function(a){var b=Q.defer(),c=new XMLHttpRequest;return c.open("GET",a,!0),c.onload=function(){c.status>=200&&c.status<400&&b.resolve(JSON.parse(c.responseText))},c.onerror=function(){},c.send(),b.promise},a})}(b.exports)},{"./core":10}],12:[function(a,b){!function(){"use strict";var b=a("./core");b.loop=function(){var a=b.context();b.loop.run(),a.shouldResize&&(b.resizeCanvas(),a.shouldResize=!1),a.try("stats","begin"),b.emit("idle"),a.try("stats","end")},b.loop.run=function(){window.requestAnimationFrame(b.loop)},b.start=function(){b.createMainCanvas("2d"),b.createStatsWidget(),b.emit("init:before"),b.emit("init"),b.get("assetsManager").waitForAll().then(function(){b.emit("init:after"),b.loop.run()})}}(b.exports)},{"./core":10}],13:[function(a,b){!function(){"use strict";b.exports={extend:function(a){var b=Object.create(a);return b.frame=function(a){return this.config.frames[a].frame},b.getFirstFrame=function(){return b.frame(Object.keys(this.config.frames)[0])},b.drawTile=function(a,c,d,e,f,g){var h=b.frame(a);c.drawImage(this.image.canvas,h.x,h.y,h.w,h.h,d,e,f||h.w,g||h.h)},b},setPixelZoom:function(a,b){if(b=b||1,1!==b){var c,d;for(c in a.frames)a.frames.hasOwnProperty(c)&&(d=a.frames[c].frame,d.x=d.x*b|0,d.y=d.y*b|0,d.w=d.w*b|0,d.h=d.h*b|0)}}}}()},{}],14:[function(a){!function(){"use strict";var b=window.held=a("./held");b.resize(function(a,b){console.log("canvas size => ["+a+"x"+b+"]")}),b.init(["assetsManager",function(a){a.addImage("images/tileset1.png","tileset1",6),a.addTileset("assets/gfx/tileset10.json","tileset10",6)}]),b.on("init:after",["assetsManager",function(a){var c=(a.getImage("tileset1"),a.getTileset("tileset10")),d=b.AsciiTilemap.create().setTileset(c).setMapData([". .. .   .   .   ...    "," .. #####        ... . .","....#___#    .  .....   ","....###A#     ........  ",". ..  ...  . .. .. ..  .","  ....... ... . .. .. .."]).createCanvasGrid(),e=b.AsciiTilemap.createViewport(d);console.log("tileset10 ground",c.frame("ground")),console.log("tilemap",d),console.log("mapView",e),b.idle(["ctx","width","height","clearBg",function(a,b,c){e.setTarget(this).setViewportSize(b,c).draw()}])}]),b.start()}()},{"./held":1}]},{},[1,2,3,5,6,8,9,10,11,12,13,14,4,7]);